# Lab Grader Web

## Обзор проекта

**Lab Grader Web** — это автоматизированная веб-платформа для проверки и оценивания лабораторных работ студентов с интеграцией GitHub CI/CD и Google Sheets.

Система позволяет автоматизировать процесс приема и проверки студенческих работ, минимизируя ручной труд преподавателей и обеспечивая объективную оценку через автоматические тесты.

## Назначение

Платформа решает следующие задачи:

- **Регистрация студентов** — связывание ФИО студента с GitHub аккаунтом
- **Автоматическая проверка работ** — валидация кода через GitHub Actions/CI
- **Управление курсами** — поддержка множественных курсов с отдельными настройками
- **Интеграция с Google Sheets** — централизованное хранение данных о студентах и оценках
- **Проверка качества кода** — анализ результатов тестирования и линтинга
- **Антиплагиат** — конфигурация проверки через MOSS (Measure Of Software Similarity)
- **Административная панель** — управление конфигурациями курсов через веб-интерфейс

## Технологический стек

### Backend
- **Python 3.12** — основной язык backend
- **FastAPI** — современный асинхронный веб-фреймворк
- **Uvicorn** — ASGI сервер для запуска приложения
- **gspread** — интеграция с Google Sheets API
- **oauth2client** — OAuth аутентификация для Google Services
- **PyYAML** — парсинг конфигурационных файлов курсов
- **requests** — взаимодействие с GitHub REST API
- **itsdangerous** — криптографическое подписывание сессий

### Frontend
- **React 19.0.0** — UI библиотека
- **Vite 6.1.0** — современный сборщик модулей
- **Material UI 7.0.2** — компоненты пользовательского интерфейса
- **Ant Design 5.24.4** — дополнительные UI компоненты
- **styled-components 6.1.16** — CSS-in-JS стилизация
- **React Router 6.23.0** — клиентская маршрутизация
- **react-i18next 13.0.1** — интернационализация (поддержка русского, английского, китайского)
- **CodeMirror** — редактор для YAML конфигураций
- **axios 1.9.0** — HTTP клиент

### Инфраструктура
- **Docker** — контейнеризация приложения
- **Nginx** — веб-сервер для статических файлов frontend
- **GitHub Actions** — CI/CD пайплайн
- **GitHub Container Registry** — хранение Docker образов

## Архитектура

Проект построен по архитектуре Single Page Application (SPA) с разделением на frontend и backend:

```
┌─────────────┐         ┌──────────────┐         ┌─────────────────┐
│   Browser   │ ──────► │   Nginx      │ ──────► │  React SPA      │
│             │ ◄────── │   (port 8080)│ ◄────── │  (Vite build)   │
└─────────────┘         └──────────────┘         └─────────────────┘
       │                                                    │
       │ API calls (/api/v1/*)                            │
       ▼                                                    ▼
┌──────────────────────────────────────────────────────────────────┐
│                   FastAPI Backend (port 8000)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────┐│
│  │   REST API   │  │     Auth     │  │   Course Management    ││
│  │  Endpoints   │  │  (Cookies)   │  │    (YAML configs)      ││
│  └──────────────┘  └──────────────┘  └────────────────────────┘│
└──────────────────────────────────────────────────────────────────┘
         │                    │                       │
         ▼                    ▼                       ▼
   ┌──────────┐      ┌──────────────┐      ┌─────────────────┐
   │  GitHub  │      │ Google Sheets│      │  Local YAML     │
   │   API    │      │     API      │      │  Configs        │
   └──────────┘      └──────────────┘      └─────────────────┘
```

## Основной функционал

### Для студентов

1. **Выбор курса и группы** — навигация через интуитивный интерфейс
2. **Регистрация** — ввод ФИО и GitHub никнейма с валидацией
3. **Отправка работы на проверку** — автоматический запуск процесса оценивания
4. **Получение результата** — мгновенная обратная связь о статусе проверки

### Для администраторов

1. **Управление курсами** — создание, редактирование, удаление курсов
2. **Редактирование конфигураций** — YAML редактор с подсветкой синтаксиса
3. **Загрузка новых курсов** — импорт конфигураций через веб-интерфейс
4. **Аутентификация** — защищенный доступ к административным функциям

### Процесс проверки работы

1. Студент заполняет форму (ФИО, GitHub никнейм, номер задания)
2. Backend проверяет:
   - Наличие студента в Google Sheets (по ФИО)
   - Существование GitHub аккаунта
   - Наличие репозитория `{org}/{github-prefix}-{taskid}-{username}`
   - Наличие `.github/workflows/` (настроен CI)
   - Наличие файла `test_main.py`
   - Получает последний коммит
   - Валидирует, что студент не модифицировал файл с тестами
   - Получает статусы всех CI проверок (workflows)
3. Результат (✓ или ✗) записывается в Google Sheets
4. Frontend отображает результат проверки

## Структура проекта

```
lab_grader_web/
├── main.py                      # Основной backend сервер
├── requirements.txt             # Python зависимости
├── backend.Dockerfile           # Backend контейнер
├── frontend.Dockerfile          # Frontend контейнер (multi-stage)
├── nginx.conf                   # Конфигурация Nginx
├── courses/                     # Конфигурации курсов
│   ├── index.yaml               # Индекс курсов (управление отображением)
│   ├── operating-systems-2025.yaml
│   ├── machine-learning-basics-2025.yaml
│   └── logos/                   # Логотипы курсов
│       ├── os-2025-spring.png
│       └── ml-2025-spring.png
├── scripts/                     # Deployment и утилиты
│   ├── switch-branch.sh         # Переключение веток на сервере
│   └── README.md
├── docs/                        # Документация
│   ├── PROJECT_DESCRIPTION.md
│   └── DEPLOYMENT.md
├── frontend/courses-front/      # React приложение
│   ├── src/
│   │   ├── components/          # React компоненты
│   │   │   ├── CourseList.jsx   # Список курсов
│   │   │   ├── GroupList.jsx    # Список групп
│   │   │   ├── LabList.jsx      # Список лабораторных
│   │   │   ├── RegistrationForm.jsx  # Форма проверки
│   │   │   ├── AdminLogin.jsx   # Админ логин
│   │   │   └── ProtectedRoute.jsx    # Защита маршрутов
│   │   ├── api/                 # API клиент (axios)
│   │   ├── locales/             # Переводы (en, ru, zh)
│   │   ├── App.jsx              # Главный компонент
│   │   └── main.jsx             # Точка входа
│   ├── public/                  # Статические ресурсы
│   ├── package.json
│   ├── vite.config.js
│   └── theme.js                 # Система дизайна
└── .github/workflows/
    └── ci.yaml                  # CI/CD pipeline

```

## API Endpoints

### Публичные маршруты

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/` | Главная страница (index.html) |
| GET | `/courses` | Список всех курсов |
| GET | `/courses/{course_id}` | Детали курса |
| GET | `/courses/{course_id}/groups` | Список групп курса |
| GET | `/courses/{course_id}/groups/{group_id}/labs` | Список лабораторных работ |
| POST | `/courses/{course_id}/groups/{group_id}/register` | Регистрация студента |
| POST | `/courses/{course_id}/groups/{group_id}/labs/{lab_id}/grade` | Проверка лабораторной работы |

### Административные маршруты

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/api/admin/login` | Вход в админ-панель |
| GET | `/api/admin/check-auth` | Проверка аутентификации |
| POST | `/api/admin/logout` | Выход из системы |
| DELETE | `/courses/{course_id}` | Удаление курса |
| GET | `/courses/{course_id}/edit` | Получение YAML конфигурации |
| PUT | `/courses/{course_id}/edit` | Сохранение изменений курса |
| POST | `/courses/upload` | Загрузка нового курса |

## Конфигурация курса

### Индексный файл курсов (`courses/index.yaml`)

Централизованное управление отображением и метаданными курсов:

```yaml
version: "1.0"

courses:
  - id: "os-2025-spring"
    file: "operating-systems-2025.yaml"
    status: "active"      # active | archived | hidden
    priority: 100         # Higher = shown first
    featured: true        # Show at top
    logo: "/courses/logos/os-2025-spring.png"  # Optional, HTTP path
```

### Файл описания курса

Каждый курс описывается в отдельном YAML файле со следующей структурой:

```yaml
course:
  name: "Операционные системы"
  semester: "Весна 2025"
  email: "instructor@example.com"

  github:
    organization: "os-course-2025"
    teachers: ["teacher1", "teacher2"]

  google:
    spreadsheet: "1ABC...XYZ"     # ID Google Sheets документа
    info-sheet: "График"           # Имя листа с расписанием (игнорируется)
    student-name-column: 1         # Столбец с ФИО студентов (0=A, 1=B, 2=C)
    lab-column-offset: 1           # Смещение столбцов лабораторных работ

  labs:
    "ЛР1":
      github-prefix: "task1"
      short-name: "ЛР1"
      taskid-max: 25
      ci: ["CI Workflow", "Linter"]
      files: ["lab1.sh"]
      moss:
        language: c
        max-matches: 1000
      report:
        - "Цель работы"
        - "Ход выполнения"
        - "Результаты"
```

**Примечание:** Метаданные отображения (статус, приоритет, логотип) хранятся в `courses/index.yaml`, а не в файлах курсов.

## Интеграции

### GitHub API
- Проверка существования пользователей
- Проверка существования репозиториев
- Получение содержимого файлов
- Получение информации о коммитах
- Получение статусов CI/CD проверок (check runs)

### Google Sheets API
- Чтение списка студентов
- Чтение GitHub никнеймов
- Запись результатов проверок
- Обновление данных о регистрации

**Конфигурация столбцов:**
- `student-name-column`: Номер столбца с ФИО студентов (0-based индексация: 0=A, 1=B, 2=C)
- `lab-column-offset`: Смещение между столбцом студента и первой лабораторной работой
- Примечание: В коде автоматически добавляется +1 для совместимости с gspread (1-based индексация)

### MOSS (Антиплагиат)
- Конфигурация языка программирования
- Настройка максимального количества совпадений
- Интеграция для проверки оригинальности кода

## Развертывание

### Локальная разработка

```bash
# Запуск через Docker Compose
docker-compose up

# Frontend будет доступен на http://localhost:8080
# Backend API на http://localhost:8000
```

### Production

Проект использует GitHub Actions для автоматической сборки и публикации Docker образов:

```yaml
# Образы публикуются в GitHub Container Registry
ghcr.io/markpolyak/lab_grader_web-frontend:latest
ghcr.io/markpolyak/lab_grader_web-backend:latest
```

### Переменные окружения

Необходимо создать файл `.env` со следующими переменными:

```bash
# GitHub
GITHUB_TOKEN=ghp_...

# Admin credentials
ADMIN_LOGIN=admin
ADMIN_PASSWORD=secure_password

# Security
SECRET_KEY=random_secret_key_for_signing_cookies
```

Также требуется файл `credentials.json` с учетными данными Google Service Account для доступа к Google Sheets API.

## Безопасность

- **Аутентификация** — cookie-based сессии с криптографическим подписыванием (itsdangerous)
- **Таймаут сессий** — автоматический выход через 1 час
- **Unprivileged контейнеры** — Docker образы работают от непривилегированного пользователя
- **Multi-stage builds** — минимизация поверхности атаки и размера образов
- **.dockerignore / .gitignore** — исключение чувствительных данных из репозитория
- **Валидация входных данных** — проверка всех пользовательских вводов
- **Защита от модификации тестов** — проверка целостности файла test_main.py

## Интернационализация

Поддержка трех языков:
- 🇷🇺 Русский (по умолчанию)
- 🇬🇧 Английский
- 🇨🇳 Китайский

Переключение языка через UI компонент в интерфейсе.

## Лицензия

MIT License (Copyright 2025 Matvey)

## Технические характеристики

- **Backend**: ~490 строк кода (main.py)
- **Frontend**: ~821 строк кода (React компоненты)
- **Общее количество файлов**: 22+ файлов кода
- **Поддерживаемые языки**: Python, JavaScript/JSX, YAML
- **Порты**: Frontend (8080), Backend (8000)

## Автор

Проект разработан для автоматизации процесса проверки лабораторных работ в образовательных учреждениях с использованием современных веб-технологий и практик DevOps.
